# Reference: http://mustache.github.io/mustache.5.html
#            https://juuso.dev/blogPosts/barbell/barbell.html
opnâ€¿cls â† "{{"â€¿"}}"

Lâ†â€¢Show

# types
types â† {
  b â‡ 1 # base node
  s â‡ 2 # start node
  e â‡ 3 # end node
}

nested â† {
  Depth â‡ {
        ğ•Š ğ•© : 0 ğ•Š ğ•©
    ; ğ•¨ ğ•Š âŸ¨âŸ© : âŸ¨ğ•¨âŸ© 
    ; ğ•¨ ğ•Š ğ•© : 1=â‰¡ğ•© ? ğ•¨
    ; ğ•¨ ğ•Š ğ•© : âˆ¾ğ•¨ ğ•Š { ğ•¨âˆ¾(ğ•¨+1)ğ”½âŠ‘1â†“ğ•© }Â¨ğ•©
  }

  Flatten â‡ {
      ğ•Š âŸ¨âŸ© : âŸ¨âŸ¨âŸ©âŸ©
    ; ğ•Š ğ•©  : 3=â‰¡ğ•© ? âˆ¾ ğ•©
    ; ğ•Š ğ•©  : âˆ¾ ğ•Š { hâ€¿t â† ğ•© â‹„ âŸ¨hâŸ© âˆ¾ ğ”½ t }Â¨ğ•©
  }
}

Delete â† { (/ğ•¨)(âŠ¢-â‹)(Â¬ğ•¨)/ğ•© }
Parent â† { gâ†âŠ”ğ•© â‹„ (â†•â‰ ğ•©) {aâ€¿wâ†ğ•¨ â‹„ (âŠâŸœa 1-Ëœaâ‹w)âŒ¾(wâŠ¸âŠ) ğ•© }Â´ (1â†“(Â»g){ğ•¨â€¿ğ•©}Â¨g) }

Depth â† { p â† ğ•© 
  L â†•â‰ p
}

Compile â† {
  # rp: replace parent, rv: replace values, r: references, t: types, p: parent, ch: characters, n: names
  rpâ€¿rv â† ğ•¨ â‹„ rn â† (â‰ rp)â¥ŠÂ¯1 â‹„ ch â† â€¢file.Chars ğ•© â‹„ r â† (â‰ ch)â¥ŠÂ¯1 â‹„ t â† p â† (â‰ ch)â¥Š0 â‹„ n â† @

  Print â† { ğ•Š: â€¢Show [rp, rv, rn] â‹„ â€¢Show [p, t, r] â‹„ â€¢Show n }

  # get open and close enclose bits
  oâ€¿c â† {âˆ¨âŸœÂ»âŸ(1-Ëœâ‰ ğ•©)(â‰ ch)â†‘ğ•©â·ch}Â¨opnâ€¿cls

  # pass: mark names in types
  { t â†© +`(Â»>âŸœÂ«o)+-(Â»âŠ¸<c) }

  # pass: remove brackets
  { d â† (Â¬oâˆ¨c) â‹„ ch dâŠ¸/ â†© â‹„ p dâŠ¸/ â†© â‹„ t dâŠ¸/ â†© â‹„ r dâŠ¸/ â†© }

  # pass: names to '$' nodes with types and references to original names
  {
    i â† (0âŠ¸â‰ â‰ Â¨)âŠ¸/âŠ”(âŠ¢-ËœÂ¬Ã—+`)Â¬t=types.b

    nm â† (Â¬âˆŠâŸœ"#/")âŠ¸/Â¨ âŠâŸœchÂ¨i # names: extracted node strings
    b â† (â‰ ch)â†‘(/â¼0âŠ‘Â¨i) # base nodes - start of nodes
    s â† types.sÃ—bâˆ§ch='#' # start nodes
    e â† types.eÃ—bâˆ§ch='/' # end nodes
    d â† (t=types.b)Ã—Â¬b

    rn â†© Â¯1Â¨âŒ¾(((â‰ nm)=nmâŠrv)âŠ¸/) nmâŠrv
    n  â†© (â‰âŸœâŠ) nm
    r  â†© (Â¬d)/(âŠnm)âŒ¾(bâŠ¸/) r
    p  â†© d Delete p
    t  â†© (Â¬d)/âŒˆÂ´bâ€¿sâ€¿e
    ch â†© (Â¬d)/'$'Â¨âŒ¾(bâŠ¸/) ch
  }

  # pass: construct parents from start/end nodes
  { p â†© +`(Â»>âŸœÂ«(t=types.s))+-(Â»âŠ¸<(t=types.e)) }

  Print @
  # pass: expand loops to flatten structure
  {
    # get depth of value tree
    # get depth of template tree

    L

    # bind variables to 
    #L (Â¯1â‰ rn)/rp
    #L (Â¯1â‰ rn)/rn
    #L (types.s=(pâŠt))
    #L (types.s=(pâŠt))âˆ§(t=types.b)
    #o â† t=types.s â‹„ c â† t=types.e
    # delete parent node
  }

}

â€¢Show "--"



json â† â€¢Import "./json.bqn"

data â†  âŸ¨
  âŸ¨"points", âŸ¨
      âŸ¨"cx", "10"âŸ©, âŸ¨"cy", "1"âŸ©
      âŸ¨"cx", "10"âŸ©, âŸ¨"cy", "1"âŸ©
  âŸ©âŸ©,
âŸ©

#â€¢Show (Flatten data)
#â€¢Show (Depth âŸ¨âŸ©)
#â€¢Show (Depth data)â‰(Flatten data)
#â€¢Show Parent 0â€¿1â€¿2â€¿1â€¿2â€¿3â€¿2â€¿1â€¿2â€¿3â€¿3â€¿2â€¿3â€¿3â€¿2
p â† (Parent (nested.Depth data))
v â† (nested.Flatten data)
#L Depth p

#d â† [0,       1,         1,    2,    3,    2,    3]
#v â† âŸ¨"points","foo", "bar", "cx", "10", "cy", "12"âŸ©

#d â† âˆ¨Â´(â†•â‰ p)âŠ¸=Â¨1â€¿2
## (â¸M)(âŠ¢-1+â¸)(~M)âŒ¿P
#L (Â¬d)
#L (/d)
#L (Â¬d)/p 
###L (/d)(âŠ¢-1+/)(Â¬d)/p 


#L x â† 0â€¿0â€¿1â€¿0â€¿3â€¿0â€¿5
##L v
##L p
#L ((Â¬d)/v)â‰x
#L ((Â¬d)/p)-x

#L (/d)(âŠ¢-1+/)(Â¬d)/p


#{

#L pâ†0â€¿0â€¿1â€¿2â€¿20â€¿4â€¿4â€¿6â€¿7â€¿20â€¿9â€¿10â€¿10â€¿10â€¿9â€¿14â€¿15â€¿20â€¿17â€¿18â€¿2
#L tâ†3â€¿2â€¿1â€¿10â€¿4â€¿10â€¿2â€¿0â€¿7â€¿4â€¿2â€¿10â€¿9â€¿10â€¿2â€¿0â€¿7â€¿2â€¿0â€¿7â€¿3
#L (pâŠt)=4


#}

{
  p â† 0â€¿0â€¿0â€¿3â€¿3â€¿3
  c â† "abcdef"
  L [p,c]

   
}



#pâ€¿v Compile "./test.mustache"

â€¢Show "done"
