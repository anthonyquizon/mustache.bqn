# parser for relaxed version of json to be used as input for mustache.bqn
# converts json into [parents,,refs]â€¿names object
# - keys and values do not need quotes
# - all values are strings
# - trailing commas are allowed

âŸ¨Parent, DeleteâŸ© â† â€¢Import "tree.bqn" 


âŸ¨
  none,str,col,com,curl_opn,curl_cls,sqr_opn,sqr_cls,quote,      # characters
  key,val,obj,arr                                                # nodes
âŸ©â†â†•13

# TODO validation with line/col numbers
Compile â‡ {
    ch â† ğ•© â‹„ t â† @ â‹„ râ†@ â‹„ n â† @ â‹„ p â† @                                                                           # t: es, r:references, n: names
    { ch (Â¬châˆŠ(@+10)â€¿' ')âŠ¸/â†© }                                                                                     # remove whitespace TODO keep line and column numbers 
    { tâ†© âˆ¨Â´âŸ¨curl_opn,curl_cls,sqr_opn,sqr_cls,col,comâŸ©Ã—châŠ¸=Â¨"{}[]:,"                                             # tokenize characters
      tâ†©tâˆ¨(strÃ—châˆŠâˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26) }
    { mâ†t=str â‹„ fâ† Â»âŠ¸< m â‹„ iâ†mÃ—+`f â‹„ z â†fâˆ¨tâ‰ str â‹„ n â†© âŠâŸœchÂ¨âŠ”1-Ëœi â‹„ ch zâŠ¸/â†© â‹„ t zâŠ¸/â†© â‹„ r â†© 1-Ëœz/fÃ—i }               # tokenize strings into reference and name vectors
    { oâ†(t=curl_opn)âˆ¨t=sqr_opn â‹„ câ†(t=curl_cls)âˆ¨t=sqr_cls â‹„ pâ†© Parent +`o-c }                                    # parse parents of brackets (ch no longer needed after tokenizing processes)
    { mâ†t=col â‹„ sâ†t=str â‹„ tâ†©(Â¬m)/keyÂ¨âŒ¾((sâˆ§Â«m)âŠ¸/)t â‹„ r (Â¬m)âŠ¸/â†© â‹„ pâ†©(Â¬m) Delete p }                                  # parse keys
    { mâ†(tâ‰ curl_cls)âˆ§(tâ‰ sqr_cls)âˆ§(tâ‰ com) â‹„ t mâŠ¸/â†© â‹„ r mâŠ¸/â†© â‹„ pâ†©m Delete p }                                       # remove unneeded nodes - closing backets and commas
    { mâ†Â»t=key â‹„ p (m/Â»â†•â‰ p)âŒ¾(mâŠ¸/) â†© }                                                                              # move object values parent to keys   
    { ptrâ‡ [p, t, r] â‹„  names â‡ n }
}
