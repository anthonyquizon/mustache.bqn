# parser for relaxed version of json to be used as input for mustache.bqn
# converts json into [parents,types,refs]â€¿names object
# - keys and values do not need quotes
# - all values are strings
# - trailing commas are allowed

âŸ¨Parent, DeleteâŸ© â† â€¢Import "tree.bqn" 


type â† { 
  noneâ‡0 â‹„ strâ‡1 â‹„ keyâ‡2 â‹„ valâ‡3 â‹„ colâ‡4 â‹„  comâ‡5
  objâ‡curly_opnâ‡6 â‹„ arrâ‡sqr_opnâ‡7 â‹„ curly_clsâ‡8 â‹„ sqr_clsâ‡9
}

# TODO validation with line/col numbers
Compile â‡ {
    ch â† ğ•© â‹„ t â† @ â‹„ râ†@ â‹„ n â† @ â‹„ p â† @                                                                           # t: typepes, r:references, n: names
    { ch (Â¬châˆŠ(@+10)â€¿' ')âŠ¸/â†© }                                                                                     # remove whitespace TODO keep line and column numbers 
    { tâ†© âˆ¨Â´âŸ¨type.curly_opn,type.curly_clsâŸ©Ã—châŠ¸=Â¨"{}"                                                               # tokenize types
      tâ†©tâˆ¨Â´âŸ¨type.sqr_opn,type.sqr_clsâŸ©Ã—châŠ¸=Â¨"[]" 
      tâ†©tâˆ¨Â´âŸ¨type.col,type.com âŸ©Ã—châŠ¸=Â¨":," 
      tâ†©tâˆ¨(type.strÃ—châˆŠâˆ¾"0aA"+âŸœâ†•Â¨10â€¿26â€¿26) }
    { mâ†t=type.str â‹„ fâ† Â»âŠ¸< m â‹„ iâ†mÃ—+`f â‹„ z â†fâˆ¨tâ‰ type.str â‹„ n â†© âŠâŸœchÂ¨âŠ”1-Ëœi â‹„ ch zâŠ¸/â†© â‹„ t zâŠ¸/â†© â‹„ r â†© 1-Ëœz/fÃ—i }     # tokenize strings into reference and name vectors
    { oâ†(t=type.curly_opn)âˆ¨t=type.sqr_opn â‹„ câ†(t=type.curly_cls)âˆ¨t=type.sqr_cls â‹„ pâ†© Parent +`o-c }                # parse parents of brackets (ch no longer needed after tokenizing processes)
    { mâ†t=type.col â‹„ sâ†t=type.str â‹„ tâ†©(Â¬m)/type.keyÂ¨âŒ¾((sâˆ§Â«m)âŠ¸/)t â‹„ r (Â¬m)âŠ¸/â†© â‹„ pâ†©(Â¬m) Delete p }                   # parse keys
    { mâ†(tâ‰ type.curly_cls)âˆ§(tâ‰ type.sqr_cls)âˆ§(tâ‰ type.com) â‹„ t mâŠ¸/â†© â‹„ r mâŠ¸/â†© â‹„ pâ†©m Delete p }                        # remove unneeded nodes - closing backets and commas
    { mâ†Â»t=type.key â‹„ p (m/Â»â†•â‰ p)âŒ¾(mâŠ¸/) â†© }                                                                         # move object values parent to keys   
    { ptrâ‡ [p, t, r] â‹„  names â‡ n }
}
